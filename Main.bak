!To execute the program , run the makefile by the 'make' command, and 
!running the executable 

program Fock_FCI
  use Precision
  use Constants
  use InputParams, only: PrintInput, NSites, Dim, Model, Delta, J2, Periodic, PBCx, PBCy, Nx, Ny
  use Operators
  use Integrals
  use BuildHamDense
  use LapackIface
  implicit none

  integer :: NDet, IAlloc, info, lwork
  integer :: NS
  real(kind=pr), allocatable :: H(:,:), evals(:), work(:)

  call PrintInput()

  ! total number of pair-levels/sites used by the Fock space
  NS = NSites()

  NDet = ishft(1, NS)
  write(*,'(A,I0)') "NDet      = ", NDet

  call SetUpPairOperators(NS)

  call SetUpIntegrals(NS)

  !---------------------------------------------
  ! Build integrals depending on geometry/model
  !---------------------------------------------
  select case (Dim)

  case (1)
    ! Option A (recommended): use Model
    if (Model == 1) then
      call DoIntegralsXXZ_1D(NS, Delta, Periodic)
    else if (Model == 2) then
      call DoIntegralsJ1J2XXZ_1D(NS, Delta, J2, Periodic)
    else
      stop "Main: unknown Model (use 1=XXZ, 2=J1J2XXZ)"
    end if

    ! Option B (legacy): uncomment if you want old behavior
    ! if (abs(J2) < 1.0e-14_pr) then
    !   call DoIntegralsXXZ_1D(NS, Delta, Periodic)
    ! else
    !   call DoIntegralsJ1J2XXZ_1D(NS, Delta, J2, Periodic)
    ! end if

  case (2)
    if (Model == 1) then
      call DoIntegralsXXZ_2D(Nx, Ny, Delta, PBCx, PBCy)
    else if (Model == 2) then
      call DoIntegralsJ1J2XXZ_2D(Nx, Ny, Delta, J2, PBCx, PBCy)
    else
      stop "Main: unknown Model (use 1=XXZ, 2=J1J2XXZ)"
    end if

  case default
    stop "Main: Dim must be 1 or 2"

  end select

  allocate(H(NDet,NDet), evals(NDet), stat=IAlloc)
  if (IAlloc /= 0) stop "Allocation failed for H/evals"

  call BuildHamiltonianDense(NS, H)

  lwork = max(1, 3*NDet - 1)
  allocate(work(lwork), stat=IAlloc)
  if (IAlloc /= 0) stop "Allocation failed for work"

  call dsyev('V','U', NDet, H, NDet, evals, work, lwork, info)
  if (info /= 0) then
    write(*,*) "DSYEV failed, info=", info
    stop
  end if

  write(*,'(A,F22.16)') "Ground-state energy = ", evals(1)

  deallocate(work, H, evals, stat=IAlloc)
  call ShutDownIntegrals()
  call ShutDownPairOperators()

end program Fock_FCI
